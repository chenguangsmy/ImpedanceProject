%Author: Shuqi Liu
%Date: 2019-12-27 17:06
%File Description: The main file to run when processing data. User needs to
%update the sessionNum variable to the target session number. The data and
%the current file needs to follow the folder structure '../SonicData/', and
%the data file name needs to be Sonic.sessionNum.mat

close all;
clear all;

%TODO: change session number each time
sessionNum = '00189';
fileName = append('../SonicData/Sonic.',sessionNum, '.mat');

%load data
dataCurr = load(fileName);

%Current experiment set up: right (-z), left(+z), top(y+), down(-y), 5 rep
%each, left-
%longer distance -> shorter
%force levels: low, mid high
%Hence the condition
%TODO: some observations: pos not symmetrical around 0, x is around -0.12, and y is around 0.5
%set up the condition index array where each row contains the 5 index of
%trials for each condition. 
allConditionIndex = zeros(24,5);
for i = 1:12
    for j = 1:2
        allConditionIndex((i-1)*2+j,:) = (i-1)*10 + j : 2 : i*10;
    end
end


%TODO: make the variables clear using global keyword and make things function. 
% global forceRows totalConditionTypes conditionIndex movementOnsetState ...
%     repPerBlock maxCols numberBlocks blocks initPlot plotPos plotForce; 

%set up global variable about if plot will be shown
initPlot = 0;
plotPos = 0;
plotForce = 0;

forceRows= 6;
totalConditionTypes = 24;
maxCols = 1000;
repPerBlock = 5;
movementOnsetState = 4;
%TODO: manually set based on the expeirment, only use complete blocks.
numberBlocks = dataCurr.Data.BlockNo(length(dataCurr.Data.BlockNo)) - 1;

%total repititions of one condition. block number * repPerBlock
%FIXME: for some reason can't use block number read from the array data for the subplot command?
blocks = numberBlocks * repPerBlock;

%initialize output variables:
AllTrialAverage = zeros(forceRows * totalConditionTypes, maxCols);
AllAlignedByBlock = zeros (forceRows * totalConditionTypes * blocks, maxCols);
AllRaw = zeros (forceRows * totalConditionTypes * blocks, maxCols);

%initialize time and data index with NaN since real data couldn't take NaN
AllDataIndex = NaN (totalConditionTypes * blocks, maxCols);
AllTime = NaN(totalConditionTypes, maxCols);

FindMaxOnsetIndex

for conditionType = 1:24
    fprintf('Processing Condition: %d\n',conditionType);
    conditionIndex = allConditionIndex(conditionType,:);
    %validate if block number is different than 5, needs to change the code
    CheckDirectionReading
%     PositionData
    ForceData 
end

outputFileName = append('Sonic', sessionNum,'ForceData-AllAligned.mat');
save(outputFileName, 'AllTrialAverage', 'AllAlignedByBlock', 'AllRaw', 'AllDataIndex', 'AllTime');

load(outputFileName);

PlotForceData;